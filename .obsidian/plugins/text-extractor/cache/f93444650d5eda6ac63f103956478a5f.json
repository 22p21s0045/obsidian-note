{"path":"Lecture Kmutt/INT204/materials/08-INT204-Spring-Rest-Api-Validation.pdf","text":"Sp r in g R E S T fu l A PI Be a n V a l i d a t i o n Ba s i c s By Pi ch e t L i m v a j i r a n a n S p r i n g B o o t L a y e r A r ch i t e ct u r e s Co n t r o lle r Bu s i n e s s L o g i c ( Se r vi c e C l a s s ) Pe r s i s t e n c e ( Re p o s i t o r y C l a s s ) Pr e s e n t a t io n En t it y En t it y JS O N JS O N Ha n d l i n g v a l i d a t i o n er r o r s i n t h e r es p o n s e. @Data @ RequiredArgsConstructor @ JsonInclude ( JsonInclude . Include .NON_NULL ) public class ErrorResponse { private final int status ; private final String message ; private final String instance ; private String stackTrace ; private List < ValidationError > errors ; public void addValidationError ( String field, String message) { if ( Objects .isNull ( errors )) { errors = new ArrayList <>(); } errors .add ( new ValidationError (field, message)); } } @Data @ RequiredArgsConstructor private static class ValidationError { private final String field ; private final String message ; } @ R e s t C o n t r o l l e r A d v i ce (1 ) @ Re s t C o n t r o l l e r A d v i c e publ i c cl a s s Gl o b a l E x c e p t i o n H a n d l e r ex t e n d s Re s p o n s e E n t i t y E x c e p t i o n H a n d l e r { @ Ex c e p ti o n H a n d l e r ( It e m N o t F o undE x c e p t io n . cl a s s ) @ Re s p o n s e S t a t u s ( Ht t p S t a t u s . N O T _ F O UN D ) publ i c Re s p o n s e E n t i t y < Er r o r R e sp o n se > ha ndl e It e m N o t F o undE x ce p t i o n ( It e m N o t F o undE x c e p t io n e x c e p t i o n , We b R e q u e s t re q u e s t ) { re t u r n bui l dE rr o rR e s po ns e ( e x c e p t i o n , Ht t p S t a t u s . N O T _ F O UN D , r e q u e s t ) ; } @ C o n t r o l l e r A d v i ce (2 ) @ Ex c e pti o n H a n d l e r ( Me t h o d A r g u me n t N o t V a l i d E x c e p t i o n . clas s ) @ Re s p o n s e S t a t u s ( Ht t p S t a t u s . UN PR O C E S S A B L E _ E N T I T Y ) publ i c Re s p o n s e E n t i t y < Err o rR e sp o n se > ha ndl e M e t ho dA r g um e n t N o t V a l i d ( Me t h o d A r g u me n t N o t V a l i d E x c e p t i o n ex , We b R e q u e s t re q u e s t ) { Err o rR e sp o n se er r o r R es p o n s e = ne w Err o rR e sp o n se ( Ht t p S t a t u s . UN PR O C E S S A B L E _ E N T I T Y .v a l u e (), \" V a l i d a t i o n e r r o r . C h e c k ' e r r o r s ' f i e l d f o r d e t a i l s . “ , request.getDescription ( false ) ); fo r ( Fi e l d E r r o r fie ld E r r or : ex . g e t B i n d i n g R e s u l t (). ge t F i e l d E r r o r s ()) { er r o r R es p o n s e .a d d V a l i d a ti o n Err o r ( fie ld E r r or .g e t F i e l d (), fie ld E r r or .g e t D e f a u l t M e s s a g e ()); } re t u r n Re s p o n s e E n t i t y . unpr o c e ssable E n t it y (). bo dy ( er r o r R es p o n s e ); } Ja v a Bea n V a l i d a ti o n • Be a n V a l i d a t i on p r o v i d e s a c om m on w a y of v a l i d a t i on t h r ou g h c on s t r a i n t d e c l a r a t i on a n d me t a d a t a f o r J a v a a p p l i c a t i o n s . • Us i n g b y a n n o t a t e d o m a i n m o d e l p r o p e r t i e s w i t h d e c l a r a t i v e v a l i d a t i o n c o n s t r a i n t s w h i c h ar e t h e n e n f o r c e d b y t h e r u n t im e . • Th er e a r e b u i l t - i n c o n s t r a i n t s , a n d y o u c a n a l s o d e f i n e y o u r o w n c u s t o m c o n s t r a i n t s . • Ex a m p l e : @T a b l e (na m e = \"o f f i c es \" ) publ i c c l a s s Of f i c e { @I d @Co l u m n (na m e = \" of fi ce C od e \" , n u l l a b l e = fa l s e , l e n g t h = 10 ) @ No t B lan k pr i v a t e St r i n g of fi ce C od e ; @Co l u m n (na m e = \"c i t y \" , n u l l a b l e = fa l s e , l e n g t h = 15 ) @S i z e (m i n= 5 ,m a x = 15 ) @ No t B lan k pr i v a t e St r i n g cit y ; im p o r t ja k a r t a . v a l i d a t i o n . c o n s t r a i n t s . No t B lan k ; im p o r t ja k a r t a . v a l i d a t i o n . c o n s t r a i n t s . No t Nu ll ; im p o r t ja k a r t a . v a l i d a t i o n . c o n s t r a i n t s . Si z e ; Co mmo n V a l i d a ti o n An n o t a ti o n s S o m e o f t h e m o s t c o m m o n v a l i d a t i o n a n n o t a t i o n s a r e : @ Not Nu l l • to s a y t h a t a f i e l d m u s t n o t b e n u l l . @ Not E mp t y • to s a y t h a t a l i s t f i e l d m u s t n o t e m p t y . @ Not Bl a n k • to s a y t h a t a s t r i n g f i e l d m u s t n o t b e t h e e m p t y s t r i n g ( i. e . it m us t ha v e a t le as t o ne c har ac t e r ) . @M in an d @M a x • to s a y t h a t a n u m e r i c a l f i e l d i s o n l y v a l i d w h e n it ’ s va l u e i s a b o v e o r b e l o w a c e r t a i n va l u e . @P a t t e rn • to s a y t h a t a s t r i n g f i e l d i s o n l y v a l i d w h e n i t m a t c h e s a c e r t a i n r e g u l a r e x p r e s s i o n . @E m ail • to s a y t h a t a s t r i n g f i e l d m u s t b e a v a l i d e m a i l a d d r e s s . Va l i d a t o r • T o v a l i d a t e i f a n o b j e c t i s v a l i d , w e p a s s i t i n t o a V a l i d a t o r w h i c h ch e ck s i f t h e c o n s t r a i n t s a r e s a t i s f i e d : @S e r v i c e publ i c c l a s s Of f i c e S e r v i c e { @ A ut o w i r e d pr i v a t e V a l i da t o r v a l i da t o r ; publ i c Of f i c e cr ea t eN e w O f f ice ( Of f i c e of f i c e ) { Er r o r s e r r o r s = v a l i da t o r . v a l i da t e O bj e c t (o f f i c e ); if ( er r o r s . ha s E r r o r s ()) { t hr o w ne w R un t i m e E x c e p t i o n ( er r o r s . t o S t r i ng ()); } r e t ur n r e po s i t o r y .s a v e (o f f i c e ); } @V a l i da ti o n & @V a l i d • We c a n u s e @V alid a t io n an d @V alid an n o t a t io n s t o le t S p r in g k n o w th a t w e w a n t t o h a v e a c e r t a i n ob j e c t v a l i d a t e d . • Th e @ V a l i d a t e d a n n ot a ti on i s a cl as s - le v e l an n o t a t io n t h a t w e c an use t o t e l l S pr i ng t o v a l i da t e pa r a m e t e r s t ha t a r e pa sse d i n t o a me th od of th e a n n ot a t e d c l a s s . • We c a n p u t t h e @ V a l i d a n n o t a t i o n on m e t h od p a r a m e t e r s a n d f i e l d s to t e l l S p r i n g t h a t w e w a n t a m e t h o d p a r a m e t e r o r f i e l d to b e va l i d a t e d . Va l i d a t i n g I n p u t t o a S p r i n g R E S T C o n t r o l l e r • Th e r e a r e th r e e th i n g s w e c a n v a l i d a t e f or a n y i n c om i n g H T TP re q u e s t : • T he r e que s t bo dy • I n P O S T a nd P U T r e que s t s , i t ’ s c o m m o n t o pa s s a J S O N pa y l o a d w i t hi n t he r e que s t bo dy . S pr i ng a ut o m a t i c a l l y m a p s t he i nc o m i ng J S O N t o a J a v a o bj e c t . N o w , w e w a n t t o c he c k i f t he i nc o m i ng J a v a o bj e c t m e e t s o ur r e qui r e m e n t s . • V a ri a b l e s w i t h i n t h e p a t h ( e. g . id in / fo o s /{ i d } ) a n d Q u e r y p a r a m e t e r s • W e ’ r e no t v a l i da t i ng c o m pl e x J a v a o bj e c t s i n t hi s c a s e , s i nc e pa t h v a r i a bl e s a nd r e que s t pa r a m e t e r s a r e pr i m i t i v e t y pe s l i k e i n t o r t he i r c o un t e r pa r t o bj e c t s l i k e I n t e g e r o r S t r i ng . Va l i d a t i n g a R e q u e s t B o d y • @Data public class NewCustomerDto { @ NotNull @Min ( 900 ) private Integer id ; @ NotEmpty @Size (min= 5 , max = 50 ) private String customerName ; @Size (min= 3 , max = 50 ) private String contactFirstName ; @Size (min= 3 , max = 50 ) private String contactLastName ; @Pattern ( regexp = \"^ \\ \\ s*(?: \\ \\ +?( \\ \\ d{1,3}))?[ - . (]*( \\ \\ d{3})[ - . )]*( \\ \\ d{3})[ - . ]*( \\ \\ d{4})(?: *x( \\ \\ d+))? \\ \\ s*$\" ) private String phone ; ^ \\ s* ( ? : \\ +? ( \\ d{ 1 ,3 } ) ) ? [ - . ( ] * ( \\ d{ 3 } ) [ - . ) ] * ( \\ d{ 3 } ) [ - . ] * ( \\ d{ 4 } ) ( ? : * x ( \\ d+ ) ) ? \\ s* $ Ex p r e ssi o n De s c r ip t io n ^ \\ s* # L i n e s t a r t , m a t c h a n y w h i t e s p a c e s a t t h e b e g i n n i n g i f a n y . (? : \\ +? ( \\ d { 1 ,3 } ) ) ? #G R O U P 1: T he c o un t r y c o de. O p t i o na l . [ - . ( ] * # A l l o w c e r t a i n no n num er i c ch a r a ct e r s t h a t m a y a p p e a r be t w een t he C o un t r y C o de a nd t he Ar ea C o de. ( \\ d{ 3} ) #G R O U P 2: T he A r ea C o de. R equi r ed. [ - . ) ] * # A l l o w c e r t a i n no n num er i c ch a r a ct e r s t h a t m a y a p p e a r b et w e e n th e A r e a C o d e a n d th e E x c h a n g e n u m b e r . ( \\ d{ 3} ) #G R O U P 3: T he E x c ha ng e num ber . R equi r ed. [ - . ] * # A l l o w c e r t a i n no n num er i c ch a r a ct e r s t h a t m a y a p p e a r be t w een t he E x c ha ng e num ber a nd t he S ub sc r i ber num ber . ( \\ d{ 4} ) #G r o up 4: T he S ub sc r i ber N um ber . R equi r ed. (? : * x ( \\ d+) ) ? #G r o up 5: T he E x t ensi o n num ber . O p t i o na l . \\ s*$ #Ma t c h a n y endi ng w hi t espa c es i f a n y a nd t he end o f s t r i ng. 18005551234 1 800 555 1234 +1 8 0 0 5 5 5 - 1234 +8 6 8 0 0 5 5 5 1 2 3 4 Gr ou p 1 : C ou n t r y C od e ( e x : 1 or 8 6 ) Gr ou p 2 : A r e a C od e ( e x : 8 0 0 ) Gr ou p 3 : E x ch a n g e ( e x : 5 5 5 ) Gr ou p 4 : S u b s cr i b e r N u m b e r ( e x : 1 2 3 4 ) Gr ou p 5 : E xt e n s i on ( e x : 5 6 7 8 ) 1 - 800 - 555 - 1234 1 (8 0 0 ) 5 5 5 - 1234 (8 0 0 )5 5 5 - 1234 (8 0 0 ) 5 5 5 - 1234 Va l i d a t i n g a R e q u e s t B o d y • T o v a l i d a t e t h e r e q u e s t b o d y o f a n i n c o m i n g H T T P r e q u e s t , w e a n n o t a t e t h e r e q u e s t b o d y w i t h t h e @ V a l i d a n n o t a t i o n i n a R E S T c o n t r o l l e r: • I f t h e v a l i d a t i o n f a i l s , i t w i l l t ri g g e r a Me t h od Ar g u m e n t N ot V a l i d E x ce p t i on . • B y d e f a u l t , S p ri n g w i l l t r a n s l a t e t h i s e x c e p t i o n t o a H T T P s t a t u s 4 0 0 ( B a d Re q u e s t ) . @ Re s t C o n t r o l l e r @ Re q u e s t M a p p i n g ( \"/ c u s t o m er s \" ) publ i c c l a s s Cu s t o m er Co n t r o l l l er { : : @ Po s t M a p p i n g ( \"\" ) publ i c Ne w C u s t o me r D t o cr e a t e C u s t om e r ( @V a l i d @ Re q u e s t B o d y Ne w C u s t o me r D t o ne w C us t o m e r ) { re t u r n se r v i c e .c r e a t e C u s t o m e r ( ne w C us t o m e r ); } } E x e r ci s e : V a l i d a t e C u s t o m e r 1. Add De pe nde ncy t o pr o j e ct . < de pe nde nc y > < gr o u p Id > o r g . s p ri n g f r a m e w o rk . b o o t </ gr o u p Id > < a rt i f a c t I d > s p ri n g - bo o t - s t a rt e r - va l i d a t i o n < / a rt i f a c t I d > </ de pe nde nc y > 2. Cr e a t e Cu s t o m e r E n t i t y ( C u s t o m e r . j a v a ) , C u s t o m e r DT O (N e w C u s t o m e r D t o . j a v a & E m p l o y e e D T O (Si m p l e E m p l o y e e D t o . j a v a ) 3. Cr e a t e Cu s t o m e r s e r v i c e 4. Cr e a t e Cu s t o m e r c o n t r o l l e r ** Y o u c a n g e t s 2 - 4 f r o m MS - Te a m s * * C u s t o m e r S e r v i ce • @S er v i c e publ i c c l a s s Cu s t o m er S er v i c e { : : publ i c Ne w C u s t o me r D t o cr e a t e C u s t om e r ( Ne w C u s t o me r D t o ne w C us t o m e r ) { if ( re p o s i t o r y .e xi s tsB yId ( ne w C us t o m e r . g e t I d ())){ th r o w n e w Re s p o n s e S t a t u s E x c e p t i o n ( Ht t p S t a t u s . CO N F L I C T , \"D u p l i c a t e c u s t o m er f o r i d \" + ne w C us t o m e r . g e t I d ()); } Cu s t o m er c u s t o m er = ma p p e r .m a p ( ne w C us t o m e r , Cu s t o m er . clas s ); re t u r n ma p p e r .m a p ( re p o s i t o r y .sa v e A n d F l u sh ( cu s t om e r ) , Ne w C u s t o me r D t o . clas s ); } publ i c Li s t < Ne w C u s t o me r D t o > ge t A l l C u s t o m e r s () { re t u r n lis t M ap p e r .m a p L i s t ( re p o s i t o r y .f i n d A l l ( ) , Ne w C u s t o me r D t o . clas s , ma p p e r ); } } Ne w Cu s t o mer & S i mp l eE mp l o y ee D T O @D a t a publ i c c l a s s Si m p l eE m p l o y eeDt o { pr i v a t e In t e g e r em p l o y eeNu m b er ; @ Js o n I g n o r e pr i v a t e St r i n g fi r s t N a m e ; @ Js o n I g n o r e pr i v a t e St r i n g las t N ame ; publ i c St r i n g ge t N a m e () { re t u r n fi r s t N a m e + ' ' + las t N ame ; } } @D a t a publ i c c l a s s Ne w C u s t o me r D t o { @ No t Nu ll @M i n ( 900 ) pr i v a t e In t e g e r id ; @ No t E mp t y @S i z e (m i n= 5 , m a x = 50 ) pr i v a t e St r i n g cu s t om e r N am e ; @S i z e (m i n= 3 , m a x = 50 ) pr i v a t e St r i n g co n t a c t F i r s t N a m e ; @S i z e (m i n= 3 , m a x = 50 ) : @ No t Nu ll pr i v a t e Si mp l e E mp l o y e e D t o sa l e s ; @M i n ( 0 ) @ Ma x ( 10000 ) @ No t Nu ll (m e s s a g e = \" C r e d i t L i m i t M u s t b e > = 0 a n d < = 1 0 ,0 0 0 \" ) pr i v a t e Do ubl e cr e d it L im it ; } Cu s t o mer Co n tr o l l er • @ RestController @ RequestMapping ( \"/customers\" ) public class CustomerControlller { @ Autowired CustomerService service ; @ GetMapping public List < NewCustomerDto > getCustomers () { return service .getAllCustomers (); } @ PostMapping ( \"\" ) public NewCustomerDto createCustomer ( @Valid @ RequestBody NewCustomerDto newCustomer ) { • return service .createCustomer ( newCustomer ); } } Te s t D a t a { \" i d\" : nul l , \" c us t o m e r N a m e \" : \"SI \" , \" co n t a c t F i r s t N a m e \" : \" K ha i t o ng \" , \" co n t a c t L a s t N a m e \" : \"L i m \" , \" pho ne \" : \"0 8 6 1 6 8 1 1 1 0 \" , \" a ddr e s s L i ne 1 \" : \" 5 4 , r ue R o y a l e \" , \" a ddr e s s L i ne 2 \" : nul l , \"c i t y \" : \"N a n t e s \" , \"s t a t e \" : nul l , \" po s t a l C o de \" : \"4 4 0 0 0 \" , \" c o un t r y \" : \" F r a nc e \" , \"s a l e s \" : { \" e m pl o y e e N um be r \" : 1370 }, \" c r e di t L i m i t \" : 9000 } { \" i d\" : 2 01 , \" c us t o m e r N a m e \" : \"SI \" , \" co n t a c t F i r s t N a m e \" : \" K ha i t o ng \" , \" co n t a c t L a s t N a m e \" : \"L i m \" , \" pho ne \" : \"0 8 6 1 6 8 1 1 1 0 \" , \" a ddr e s s L i ne 1 \" : \" 5 4 , r ue R o y a l e \" , \" a ddr e s s L i ne 2 \" : nul l , \"c i t y \" : \"N a n t e s \" , \"s t a t e \" : nul l , \" po s t a l C o de \" : \"4 4 0 0 0 \" , \" c o un t r y \" : \" F r a nc e \" , \"s a l e s \" : { \" e m pl o y e e N um be r \" : 1370 }, \" c r e di t L i m i t \" : 9000 } { \" i d\" : 901 , \" c us t o m e r N a m e \" : \" S I T V i n t a g e S ho p\" , \" co n t a c t F i r s t N a m e \" : \" K ha i t o ng \" , \" co n t a c t L a s t N a m e \" : \"L i m \" , \" pho ne \" : \"0 8 6 1 6 8 1 1 1 0 \" , \" a ddr e s s L i ne 1 \" : \" 5 4 , r ue R o y a l e \" , \" a ddr e s s L i ne 2 \" : nul l , \"c i t y \" : \"N a n t e s \" , \"s t a t e \" : nul l , \" po s t a l C o de \" : \"4 4 0 0 0 \" , \" c o un t r y \" : \" F r a nc e \" , \"s a l e s \" : { \" e m pl o y e e N um be r \" : 1370 }, \" c r e di t L i m i t \" : 9000 } Va l i d a t i n g I n p u t t o a S p r i n g S e r v i c e Me t h o d • I n s t e a d o f ( o r a d d i t i o n a l l y t o ) v a l i d a t i n g i n p u t o n t h e c o n t r o l l e r l e v e l , we c a n a l s o v a l i d a t e t h e i n p u t t o a n y S p r i n g c o m p o n e n t s . In o r d e r t o t o t h i s , w e u s e a c o m b i n a t i o n o f t h e @ V a l i d a t e d a n d @ V a l i d an n o t a t io n s : @ Service @ Validated class ValidatingService { void validateCustomer ( @Valid Customer customer){ // do something } } Va l i d a t i n g P a t h Va r i a b l e s a n d R e q u e s t P a r a m e t e r s • I n s t e a d o f a n n o t a t i n g a c l a s s f i e l d l i k e a b o v e , w e ’ r e a d d i n g a c o n s t r a i n t a n n o t a t i o n ( i n th i s c a s e @ M i n ) d i r e c tl y t o th e m e th o d p a r a m e t e r i n th e S p r i n g c o n tr o l l e r • In c o n t r as t t o r e que s t bo dy v alida t io n a f aile d v alida t io n w ill t rig g e r a Ha n d l er M e t h o d V a l i d a t i o n E x c ep t i o n in s t e ad o f a Me t ho dA r g um e n t N o t V a l i dE x ce p t i o n . @ Ge t M a p p i n g ( \"\" ) publ i c Re s p o n s e E n t i t y < Ob j e c t > ge t A l l P r o d u c t s ( @ Re q u e s t P a r a m ( de f a ul t V a l ue = \"\" ) St r i n g pa r t O f P r o duc t N a m e , @ Re q u e s t P a r a m ( de f a ul t V a l ue = \"0 \" ) Do ubl e lo w e r , @ Re q u e s t P a r a m ( de f a ul t V a l ue = \"0 \" ) Do ubl e uppe r , @ Re q u e s t P a r a m ( de f a ul t V a l ue = \"\" ) St r i n g so rtB y , @ Re q u e s t P a r a m ( de f a ul t V a l ue = \"A S C\" ) St r i n g so rtD i r e c ti o n , @ Re q u e s t P a r a m ( de f a ul t V a l ue = \"0 \" ) @M i n ( 0 ) in t pa g e N o , @ Re q u e s t P a r a m ( de f a ul t V a l ue = \"1 0 \" ) @M i n ( 10 ) in t pa g e S i z e ) { // yo u r ex i st i n g co d e } Add H an d ler me t h od to C o nt r o l l e r A d v i c e @ Ex c e pti o n H a n d l e r ( Ha n d l er M e t h o d V a l i d a t i o n E x c ep t i o n . clas s ) publ i c Re s p o n s e E n t i t y < Err o rR e sp o n se > ha ndl e H a ndl e r M e t ho dV a l i da t i o nE x c e p t i o n ( Ha n d l er M e t h o d V a l i d a t i o n E x c ep t i o n e x c e p t i o n , We b R e q u e s t re q u e s t ) { Err o rR e sp o n se er r o r R es p o n s e = ne w Err o rR e sp o n se ( \"I n v a l i d p a r a m e t er ( s ) \" , Ht t p S t a t u s . UN PR O C E S S A B L E _ E N T I T Y .v a l u e (), \"V a l i d a t i o n er r o r . Ch ec k ' er r o r s ' f i el d f o r d e t a i l s . \" , re q u e s t . g e t D e s c r i p t i o n ( fa l s e )); Li s t < Pa r a m e t e r V a l i d a t i o n R e s u l t > pa r a m N a m e s = ex c e p t i o n . g e t A l l V a l i d a t i o n R e s u l t s (); fo r ( Pa r a m e t e r V a l i d a t i o n R e s u l t pa r a m : pa r a m N a m e s ) { er r o r R es p o n s e .a d d V a l i d a ti o n Err o r ( pa r a m .g e t M e t h o d P a r a m e t e r (). ge t P a r a m e t e r N a m e (), pa r a m .g e t R e s o l v a b l e E r r o r s (). g e t ( 0 ). ge t D ef a u l t M e s s a ge () + \" ( \" + pa r a m .g e t A r g u m e n t (). to S t r i n g ()+ \") \" ); } re t u r n Re s p o n s e E n t i t y . unpr o c e ssable E n t it y (). bo dy ( er r o r R es p o n s e ); }","libVersion":"0.3.1","langs":""}