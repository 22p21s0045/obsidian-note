{"path":"Lecture Kmutt/INT209/2023-INT209-06-Docker Compose v0.9.1.pdf","text":"INT 2 0 9 D ev O p s Ol a r n R o j a n a po r n pu n Th u rs d ay , 1 6 May 2 0 2 4 LA B - 06 Do ck er C o m p o s e IN T 2 0 9 De v Op s D o c k er C o m p o s e ❍ A to o l f o r d e f ining and r u nning mu lti - co n t a in e r ap p lic atio ns ❍ Co mp o s e mak e s it e as y to manag e se r v ic e s , ne tw o r k s , and vo lu m e s in a sin g le , co m p r e he ns ib le Y A M L co nf igu r at io n f ile ❍ Cr e ate and s tar t all the s e r v ic e s w ith a s ing le c o mmand ❍ S t a r t , s t o p , a n d r eb u ild s er v ic es ❍ V iew t h e s t a t u s o f r u n n in g s er v ic es ❍ S t r ea m t h e lo g o u t p u t o f r u n n in g s er v ic es ❍ Ru n a o n e - o f f c o m m a n d o n a s er v ic e 2 ht t p s : / / d oc s . d oc k e r . c om / c om p os e / IN T 2 0 9 De v Op s R ef er en c es ❍ ht t p s : / / d oc s . d oc k er . c om / r ef er enc e/ c l i / d oc k er / c om p os e ❍ ht t p s : / / d oc s . d oc k er . c om / c om p os e/ c om p os e - fi l e / 0 5 - se r v i ce s 3 ht t p s : / / d oc s . d oc k e r . c om / r e f e r e nc e / c li/ d oc k e r / c om p os e ht t p s : / / d oc s . d oc k e r . c om / c om p os e / c om p os e - file / 0 5 - se r v ice s IN T 2 0 9 De v Op s C o m p o s e F ile ❍ Th e d ef a ult p a t h f or a C om p os e f ile is co m p o s e .y a m l ( pr e f e r r e d ) o r co m p o s e .y m l that is p lac e d in the w o r k ing d ir e c to r y ❍ Co mp o s e als o s u p p o r ts do c k e r - co m p o s e .y a m l and do c k e r - co m p o s e .y m l fo r b a ck w a r d s co m p a t ib ilit y o f e a r lie r ve r s io n s ❍ If b o t h f ile s e x is t , C o m p o s e p r e f e r s t h e c a n o n ic a l co m p o s e .y a m l 4 IN T 2 0 9 De v Op s D o c k er C o m p o s e C o m m a n d s 5 # To only build docker image docker compose build # To force build Docker Image everytime docker compose up --build # To choose custom Docker Compose file docker compose up -f custom-compose.yml # To run Docker Compose in background docker compose up -d # To stop all containers after docker compose up -d docker compose stop # To start all containers after docker compose stop docker compose start # To restart all containers docker compose restart # To show status of containers docker compose ps # To show all containers processes docker compose top # To list all images in Docker Compose file docker compose images # To stop and clean all docker compose up resources docker compose down IN T 2 0 9 De v Op s d a t ep r o j – compose.yaml 6 services: fe: image: dateproj/fe build: dateproj-fe networks: front-tier: ipv4_address: 172.16.0.3 aliases: - dateproj-fe restart: unless-stopped networks: front-tier: ipam: config: - subnet: \"172.16.0.0/24\" FR O N TEN D IN T 2 0 9 De v Op s d a t ep r o j – compose.yaml 7 services: api: image: dateproj/api build: context: dateproj-api dockerfile: multi.Dockerfile networks: front-tier: ipv4_address: 172.16.0.4 aliases: - dateproj-api back-tier: ipv4_address: 172.16.1.4 restart: unless-stopped networks: front-tier: ipam: config: - subnet: \"172.16.0.0/24\" back-tier: ipam: config: - subnet: \"172.16.1.0/24\" AP I IN T 2 0 9 De v Op s d a t ep r o j – compose.yaml 8 services: proxy: image: nginx:alpine configs: - source: proxy_config target: /etc/nginx/conf.d/default.conf depends_on: - fe - api networks: front-tier: ipv4_address: 172.16.0.2 ports: - \"80:80\" restart: unless-stopped configs: proxy_config: file: dateproj-proxy/dateproj.conf PR OX Y server { listen 80 default_server; server_name lvm65999.sit.kmutt.ac.th; location /dateproj/ { proxy_pass http://dateproj-fe/; } location /dateproj/api/ { proxy_pass http://dateproj- api:8080/api/; } } dateproj.conf IN T 2 0 9 De v Op s D ep lo y A P I c o m p o n en t 9 # create and start api service only # run in foreground to view messages docker compose up api [CTRL+C] # list all containers in the compose # note the container name docker compose ps -a docker network ls # start api container docker compose start api # list all containers in the compose docker compose ps -a # inspect api container # note networks; IPAdress/Aliases docker inspect dateproj-api-1 # stop and remove containers, networks docker compose down api docker compose ps -a docker network ls run dateproj - api mkdir 209lab6; cd 209lab6 git clone https://github.com/olarnr/int210-dateproj.git dateproj cd dateproj # modify endpoint to /api/dates nano dateproj- api/src/main/java/com/example/demo/DemoApplica tion.java # create and start api service in background # note that the image is NOT build again docker compose up -d api # build image before starting container docker compose up api -d –build docker compose logs # test that the API has been updated curl 172.16.0.4:8080/api/dates IN T 2 0 9 De v Op s D ep lo y FE an d P R O X Y c o m p o n en t s 10 # create and start fe service only docker compose up fe [CTRL+C] # start fe container docker compose start fe # view processes in containers docker compose top # view images of compose docker compose images run dateproj - fe # create and start proxy service only docker compose up proxy [CTRL+C] # start fe container docker compose start proxy # view containers docker compose ps docker compose down docker compose images run dateproj - proxy ❍ Ope n t h e pa g e o n br o w s e r ❍ No t e t h e p r o b l em w i t h f et c h i n g AP I ❍ Try t o f i x t h e p rob l e m IN T 2 0 9 De v Op s E x p er im en t w it h depends_on 11 # start all services # note the order the services are started docker compose up -d docker compose down # create and start proxy service only # note the services that are started docker compose up -d proxy docker compose down # modify compose.yaml, comment depends_on # note the order the services are started docker compose up -d docker compose down IN T 2 0 9 De v Op s s t u d en t pro j – compose.yaml 12 services: proxy: image: nginx:alpine configs: - source: proxy_config target: /etc/nginx/conf.d/default.conf depends_on: - fe - api networks: front-tier: ipv4_address: 172.15.0.2 ports: - \"80:80\" restart: unless-stopped configs: proxy_config: file: studentproj-proxy/proxy.conf PR OX Y server { listen 80 default_server; server_name lvm65999.sit.kmutt.ac.th; location / { proxy_pass http://studentproj-fe/; } location /api/ { proxy_pass http://studentproj- api:8080/api/; } } prox y . conf IN T 2 0 9 De v Op s s t u d en t pro j – compose.yaml 13 services: fe: image: ghcr.io/olarnr/studentproj/fe build: context: https://github.com/olarnr/int210-studentproj.git#main:studentproj-fe dockerfile: multi.Dockerfile networks: front-tier: ipv4_address: 172.15.0.3 aliases: - studentproj-fe restart: unless-stopped networks: front-tier: ipam: config: - subnet: \"172.15.0.0/24\" FR O N TEN D IN T 2 0 9 De v Op s s t u d en t p r o j – compose.yaml 14 services: api: image: ghcr.io/olarnr/studentproj/api build: context: https://github.com/olarnr/int210-studentproj.git#main:studentproj-api dockerfile: multi.Dockerfile environment: - mysql_url=studentproj-db depends_on: db: condition: service_healthy networks: front-tier: ipv4_address: 172.15.0.4 aliases: - studentproj-api back-tier: ipv4_address: 172.15.1.4 restart: unless-stopped networks: back-tier: ipam: config: - subnet: \"172.16.1.0/24\" AP I IN T 2 0 9 De v Op s s t u d en t p r o j – compose.yaml 15 services: db: image: mysql/mysql-server env_file: studentproj-db/env.list volumes: - ./studentproj-db/scripts:/docker-entrypoint-initdb.d - db-datadir:/var/lib/mysql healthcheck: test: [\"CMD\", \"/healthcheck.sh\"] interval: 2s timeout: 2s retries: 20 networks: back-tier: ipv4_address: 172.15.1.5 aliases: - studentproj-db restart: unless-stopped volumes: db-datadir: DB","libVersion":"0.3.1","langs":""}