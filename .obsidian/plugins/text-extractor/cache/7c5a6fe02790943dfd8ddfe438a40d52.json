{"path":"Lecture Kmutt/INT204/materials/07-INT204-Spring-Rest-Api-Exception-Handling.pdf","text":"Sp r in g R E S T fu l A PI Ex c ep t io n Handling By Pi ch e t L i m v a j i r a n a n S p r i n g B o o t L a y e r A r ch i t e ct u r e s Co n t r o lle r Bu s i n e s s L o g i c ( Se r vi c e C l a s s ) Pe r s i s t e n c e ( Re p o s i t o r y C l a s s ) Pr e s e n t a t io n En t it y En t it y JS O N JS O N HT T P St a t u s Co d es • W h e n a c l i e n t m a k e s a r e q u e s t t o a n H T T P s e r v e r - a n d t h e s e r v e r s u c c e s s f u l l y r e c e i v e s t h e r e q u e s t - t h e s e r v e r m u s t n o t i f y t h e c l i e n t i f t h e r e q u e s t w a s s u c c e s s f u l l y h a n d l e d o r n o t . • H T T P a c c o m p l i s h e s t h i s w i t h f i v e c a t e g o r i e s o f s t a t u s c o d e s : • 100 - le v e l (In f o r m a t io n al) - se r v e r a c k n o wl e d g e s a r e q u e s t • 200 - le v e l (S u c c e s s ) - se r v e r c om p l e t e d t h e r e q u e s t a s e x p e c t e d • 300 - le v e l (R e d ir e c t io n ) - cl i e n t ne e ds t o pe rf o rm f urt he r a ct i o ns t o c o m pl e t e t he re q u e s t • 400 - le v e l (C lie n t e r r o r ) - cl i e n t s e n t a n i n v a l i d r e que s t • 500 - le v e l (S e r v e r e r r o r ) - se r v e r f a i l e d t o f u l f i l l a v a l i d r e q u e s t d u e t o a n e r r or wi t h se r v e r • B a s e d o n t h e r e s p o n s e c o d e , a c l i e n t c a n s u r m i s e t h e r e s u l t o f a p a r t i c u l a r re q u e s t . Ha n d l i n g E r r o r s • T h e f i r s t s t e p i n h a n d l i n g e r r o r s i s t o p r o v i d e a c l i e n t w i t h a p r o p e r s t a t u s co d e . A d d i t i o n a l l y , w e m a y n e e d t o p r o v i d e m o r e i n f o r m a t i o n i n t h e r e s p o n s e b o d y . • B a s i c R e s p o n s e s • Th e s i m p l es t w a y w e h a n d l e er r or s i s t o r es p on d w i t h a n a p p r op r i a t e s t a t u s c od e. • Her e a r e s o me c o mmo n r es p o n s e c o d es : • 400 B a d R e q u e s t - c l i e n t s e n t a n i n v a l i d r e q u e s t , s u c h a s l a c k i n g r e q u i r e d r e q u e s t b o d y o r par am e t e r • 401 U n a u t h ori z e d - cl i e n t f a i l e d t o a u t h e n t i c a t e w i t h t h e s e r v e r • 403 F orb i d d e n - cl i e n t a u t h e n t i c a t e d b u t d o e s n o t h a v e p e r m i s s i o n t o a cce s s t h e r e q u e s t e d re s o u r c e • 404 N ot F ou n d - th e r e q u e s t e d r e s o u r c e d o e s n o t e x i s t • 412 P r e c on d i t i on F a i l e d - on e or m or e c on d i t i on s i n t h e r e q u e s t h e a d e r f i e l d s e v a l u a t e d to fa l s e • 500 I n t e rn a l S e r v e r E rr or - a g e ne r ic e r r o r o c c ur r e d o n t he s e r v e r • 503 S e r v i c e U n a v a i l a b l e - th e r e q u e s t e d s e r v i c e i s n o t a v a i l a b l e St a n d a r d i z ed R esp o n se B o d i es • I n a n e f f o r t t o s t a n d a r d i z e R E S T A P I e r r o r h a n d l i n g , t h e I E T F d e v i s e d R F C 7 8 0 7 , w h i c h c r e a t e s a g e n e r a l i z e d e r r o r - h a n d l i n g s c h e m a . • T h i s s c h e m a i s c o m p o s e d o f f i v e p a r t s : • ty p e - a UR I i d e n t i f i e r t h a t c a t e g o r i z e s t h e e r r o r • ti tl e - a b r i e f , h u m a n - re a d a b l e m e s s a g e a b o u t t h e e r r o r • st a t u s - t h e H T T P r e s p o n s e c o d e ( o p t i o n a l ) • de t a i l - a h u m an - re a d a b l e e x p l a n a t i o n o f t h e e r r o r • in s t an c e - a UR I t h a t i d e n t i f i e s t h e s p e c i f i c o c c u r r e n c e o f t h e e r r o r { \"t y p e\" : \"/ er r o r s / i n c o r r ec t - us e r - pa s s \" , \"t i t l e\" : \"I n c o r r ec t u s er n a m e o r p a s s w o r d . \" , \"s t a t u s \" : 401 , \"d e t a i l \" : \"A u t h en t i c a t i o n f a i l ed d u e t o i n c o r r ec t u s er n a m e o r p a s s w o r d . \" , \"i n s t a n c e\" : \"/ l o g i n / l o g / a b c 1 2 3 \" } Re s t A p i - E x ce p t i o n H a n d l i n gE x ce p t i o n H a n d l i n g • Ha ndl i ng e x c e p t i o ns i s a n i m po r t a n t pa r t o f bui l di ng a r o bus t ap p lic a t io n . • S p r i n g B o o t p r o v i d e s t o o l s t o h a n d l e e x c e p t i o n s b e y o n d s i m p l e ‘t r y - c a t c h ’ b l o c k s . • @ Re s p o n s e S t a t u s • @ Ex c ep t i o n Ha n d l er • @ C o n t r o l l e rA d v i c e Sp ri n g B o o t ’ s D e f a u l t E x ce p t i o n H a n d l i n g Me ch a n i sm se r v e r .e rr o r .i n c l u d e - st a c k t r a c e = on _ p a r a m se r v e r .e rr o r .i n c l u d e - ex c e p t i o n = tru e se r v e r .e rr o r .i n c l u d e - st a c k t r a c e = alway s @ Re s p o n s e S t a t u s • A s t h e n a m e s u g g e s t s , @ Re s p o n s e S t a t u s a l l o w s u s t o m o d i f y t h e H T T P s t a t u s o f o u r re s p o n s e . I t c a n b e a p p l i e d i n t h e f o l l o w i n g p l a c e s : • On t h e e x c e p t i o n c l a s s i t s e l f • Al o n g w i t h t h e @ Ex c e p t i o n H a n d l e r anno t a t io n o n m e t ho ds • Al o n g w i t h t h e @ Co n t r o l l e rAd v i c e anno t a t io n o n c las s e s • I n t h i s s e c t i o n , w e ’l l b e l o o k i n g a t t h e f i r s t c a s e o n l y . @ Re s p o n s e S t a t u s (v a l u e = Ht t p St a t u s . NO T _ F O U ND ) publ i c c l a s s It e mN o t F o undE x c e p t io n ex t e n d s Ru n t i m e Ex c e p t i on { publ i c It e mN o t F o undE x c e p t io n ( St r i n g me s s ag e ) { su p e r (m es s a g e); } publ i c Pr o d u c t ge t P r o d u c t B y I d ( St r i n g pr o duc t C o de ) { re t u r n re p o .f i n d B y I d ( pr o duc t C o de ). or E l s e T h r o w ( () - > ne w It e m N o tF o u n d Ex c e pti o n ( \"P r o d u c t c o d e: \" + pr o duc t C o de + \" d o es n o t ex i st s !!!\" )); } Ano the r w a y to a c h i e v e t h e s a m e i s b y e x te n d i n g t h e Re s p o n s e S t a t u s E x c e p t i o n cl a s s im p o r t or g. s p r i n gfr a m e w or k . h t t p . H t t p S t a t u s ; im p o r t or g. s p r i n gfr a m e w or k . w e b . s e r v e r . R e s p on s e S t a t u s E x ce p t i on ; publ i c c l a s s It e m N o tF o u n d Ex c e pti o n ex t e n d s Re s p o n s e S t a t u s E x c e p t i o n { publ i c It e m N o tF o u n d Ex c e pti o n ( St r i n g me s s a g e ) { su p e r ( Ht t p S t a t u s . NO T _ F O U ND , m e s s a g e ) ; } } @ Re s p o n s e S t a t u s , i n c o m b i n a t i o n w i t h t h e se r ve r . e r r o r con fi g u ra t i on prope rt i e s , a l l ow s us t o m a n i p ul a t e a l m o s t a l l t h e f i e l d s i n o ur S p r i n g - de f i n e d e r r o r r e s p o n s e p ay l o ad. @ Ex c e p ti o nH a ndl e r • Th e @ Ex c e p ti o n H a n d l e r an n o t a t io n g iv e s u s a lo t o f f le x ib ilit y in t e r m s o f h an d lin g ex c e p t i o n s . • F o r s t a r t e r s , t o u s e i t , w e s i m p l y n e e d t o c r e a t e a m e t h o d e i t h e r i n t h e co n t r o l l e r i t s e l f or in a @ Re s t C o n t r o l l e r A d v i c e cl a s s a nd a nno t a t e i t w i t h @ Ex c e p ti o n H a n d l e r : @ Re s t C o n t r o l l e r publ i c clas s Pr o d u c t C o n t r o l l e r { : @ Ex c e pti o n H a n d l e r ( It e m N o tF o u n d Ex c e pti o n . clas s ) @ Re s p o n s e S t a t u s ( Ht t p S t a t u s . NO T _ F O U ND ) publ i c It e m N o tF o u n d Ex c e pti o n ha ndl e I t e m N o t F o und ( It e m N o tF o u n d Ex c e pti o n ex c e p t i o n ) { re t u r n ex c e p t i o n ; } publ i c c l a s s It e mN o t F o undE x c e p t io n ex t e n d s Ru n t i m e Ex c e p t i on { publ i c It e mN o t F o undE x c e p t io n ( St r i n g me s s ag e ) { su p e r (m es s a g e); } @Ov e rri d e publ i c s y nc hr o ni z e d Th r o w a b l e fi l l I n S t a c k T r a c e () { re t u r n t h i s ; } E x ce p t i o n E r r o r C o d e • N o w , l e t ’ s f i n a l i z e a n e r r o r r e s p o n s e p a y l o a d f o r o u r A P I s . I n c a s e o f a n y e r r o r , c l i e n t s u s u a l l y e xp e c t t w o t h i n g s : • A n e rr o r c o d e t h a t t e l l s t h e c l i e n t w h a t k i n d o f e rr o r i t i s . E rr o r c o d e s c a n b e u s e d b y c l i e n t s i n t h e i r c o d e t o d ri v e s o m e b u s i n e s s l o g i c b a s e d o n i t . • U s u a l l y , e rr o r c o d e s a r e s t a n d a r d H T T P s t a t u s c o d e s , b u t I h a v e a l s o s e e n A P I s r e t u rn i n g c u s t o m e rr o r s c o d e l i k e s E 0 0 1 . • An a ddi t i o na l hum a n - re a d a b l e m e s s a g e w h i c h g i v e s m o re i n f o r m a t i o n o n t h e e r r o r a n d e v e n s o m e h i n t s o n h o w t o f i x t h e m o r a lin k t o A P I d o c s . • We w i l l a l s o a d d a n o p t i o n a l st a c k T r a c e fie ld w h ic h w ill h e lp u s w it h de bug g i ng i n t he de v e l o pm e n t e n v i r o nm e n t . Ha n d l i n g v a l i d a t i o n er r o r s i n t h e r es p o n s e. @G e t t e r @S e t t e r @ R e qui r e dA r g s C o ns t r uc t o r @ J s o nI nc l ude ( J s o nI nc l ude . I nc l ude . NO N_ NU LL ) publ i c c l a s s E r r o r R e s po ns e { pr i v a t e f i na l i n t s t a t us ; pr i v a t e f i na l S t r i ng me ssa g e ; pr i v a t e f i na l S t r i ng i ns t a nc e ; pr i v a t e S t r i ng st a c k T r a c e ; pr i v a t e Li s t < V a l i da t i o nE r r o r > er r o r s ; @G e t t e r @S e t t e r @ R e qui r e dA r g s C o ns t r uc t o r pr i v a t e s t a t i c c l a s s V a l i da t i o nE r r o r { pr i v a t e f i na l S t r i ng fi e l d ; pr i v a t e f i na l S t r i ng me ssa g e ; } publ i c v o i d a ddV a l i da t i o nE r r o r ( S t r i ng f i e l d, S t r i ng me ssa g e ) { if ( O bj e c t s . is N u ll ( er r o r s )){ er r o r s = ne w Ar r a y L i s t <>( ) ; } er r o r s . a dd ( ne w V a l i da t i o nE r r o r ( f i e l d, m e s s a g e ) ) ; } } @ ExceptionHandler ( ItemNotFoundException . class ) @ ResponseStatus (code = HttpStatus .NOT_FOUND ) public ResponseEntity < ErrorResponse > handleItemNotFound ( ItemNotFoundException ex, WebRequest request) { ErrorResponse er = new ErrorResponse ( HttpStatus .NOT_FOUND .value (), ex.getMessage (), request.getDescription ( false ) ); return ResponseEntity .status ( HttpStatus .NOT_FOUND ).body( er ); } @ R e s t C o n t r o l l e r A d v i ce • Th e t er m ' A d v i c e' c om es fr om A s p ec t - O r i e n t e d Pr o g r a m m i n g ( A O P) w h i c h a l l o w s u s t o in j e c t c r o s s - cut t i ng c o de ( c a l l e d \" a dv i ce \" ) a r o und e x i s t i ng m e t ho ds . A c o n t r o l l e r a dv i ce a l l o w s u s t o i n t e r c e p t a n d m o d i f y t h e r e t u r n v a l u e s o f c o n t r o l l e r m e t h o d s , i n o u r c a s e t o ha ndl e e x ce p t i o ns . • Con t r ol l e r a d v i c e c l a sse s a l l o w u s t o a p p l y e x c e p t i on h a n d l e r s t o m or e t h a n on e or a l l co n t r o l l e r s i n o u r a p p l i cat i o n : • If w e w an t t o s e le c t iv e ly apply o r lim it t he s c o pe o f t he c o n t r o lle r adv ic e t o a part ic ular c o n t r o l l e r , o r a p a c k a g e , w e c a n u s e t h e p r o p e r t i e s p r o v i d e d b y t h e a n n o t a t i o n : • @ Re s t C o n t r o l l e r A d v i c e (\" co m . r e f l e c t o r i n g . co n t r o l l e r \") : w e c a n p a s s a p a c k a g e n a me or l i s t of p a c k a g e n a m e s i n t h e a n n ot a t i on ’ s v a l u e or ba s e P a ck a g e s pa r a m e t e r . W i t h t h i s , t h e c o n t r o l l e r a d v i c e w i l l o n l y h a n d l e e x c e p t i o n s o f t h i s p a c k a g e ’ s c o n t r o l l e r s . • @ Re s t C o n t r o l l e r A d v i c e ( as s ig n ab le T y p e s ={ Con t r ol l e r . c l a ss } ): o nly c o n t r o lle r s s pe c if y by as s ig n ab le T y p e wi l l b e h a n d l e d b y t h e c on t r ol l e r a d v i c e . Ho w D o es S pr i ng P r o ces s T he E x cep t i o ns ? @ R e s t C o n t r o l l e r A d v i ce (1 ) @ R e s t C o n t r o l l e r A dv i c e publ i c c l a s s G l o ba l E x c e p t i o nH a ndl e r e x t e nds R e s po ns e E n t i t y E x c e p t i o nH a ndl e r { publ i c s t a t i c f i na l S t r i ng TRA C E = \"t r a c e \" ; @ E x c e p t i o nH a ndl e r ( I t e m N o t F o undE x c e p t i o n . clas s ) @ R e s po ns e S t a t us ( H t t pS t a t us . NO T _ F O U ND ) publ i c R e s po ns e E n t i t y < E r r o r R e s po ns e > ha ndl e I t e m N o t F o undE x c e p t i o n ( I t e m N o t F o undE x c e p t i o n e x c e p t i o n, W e bR e que s t r e que s t ) { r e t ur n bui l dE r r o r R e s po ns e ( e x c e p t i o n, H t t pS t a t us . NO T _ F O U ND , r e que s t ) ; } @ C o n t r o l l e r A d v i ce (2 ) @ Ex c e pti o n H a n d l e r ( Me t h o d A r g u me n t N o t V a l i d E x c e p t i o n . clas s ) @ Re s p o n s e S t a t u s ( Ht t p S t a t u s . UN PR O C E S S A B L E _ E N T I T Y ) publ i c Re s p o n s e E n t i t y < Err o rR e sp o n se > ha ndl e M e t ho dA r g um e n t N o t V a l i d ( Me t h o d A r g u me n t N o t V a l i d E x c e p t i o n ex , We b R e q u e s t re q u e s t ) { Err o rR e sp o n se er r o r R es p o n s e = ne w Err o rR e sp o n se ( Ht t p S t a t u s . UN PR O C E S S A B L E _ E N T I T Y .v a l u e (), \" V a l i d a t i o n e r r o r . C h e c k ' e r r o r s ' f i e l d f o r d e t a i l s . “ , request.getDescription ( false ) ); fo r ( Fi e l d E r r o r fie ld E r r or : ex . g e t B i n d i n g R e s u l t (). ge t F i e l d E r r o r s ()) { er r o r R es p o n s e .a d d V a l i d a ti o n Err o r ( fie ld E r r or .g e t F i e l d (), fie ld E r r or .g e t D e f a u l t M e s s a g e ()); } re t u r n Re s p o n s e E n t i t y . unpr o c e ssable E n t it y (). bo dy ( er r o r R es p o n s e ); } @ C o n t r o l l e r A d v i ce (3 ) @ Ex c e pti o n H a n d l e r ( Ex c e pti o n . clas s ) @ Re s p o n s e S t a t u s ( Ht t p S t a t u s . IN T ER N A L _ S ER V ER _ ER R O R ) publ i c Re s p o n s e E n t i t y < Err o rR e sp o n se > ha ndl e A l l U nc a ug h t E x c e p t i o n ( Ex c e pti o n e x c e p t i o n , We b R e q u e s t re q u e s t ) { re t u r n bui l dE r r o r R e s po ns e ( e x c e p t i o n , \"U n k n o w n er r o r o c c u r r ed \" , Ht t p S t a t u s . IN T ER N A L _ S ER V ER _ ER R O R , r e q u e s t ); } @ C o n t r o l l e r A d v i ce (4 ) pr i v a t e R e s po ns e E n t i t y < E r r o r R e s po ns e > bui l dE r r o r R e s po ns e ( E x c e p t i o n e x c e p t i o n, H t t pS t a t us h t t pS t a t us , W e bR e que s t r e que s t ) { r e t ur n bui l dE r r o r R e s po ns e ( e x c e p t i o n, e x c e p t i o n. g e t M e s s a g e ( ) , h t t pS t a t us , r e que s t ) ; } pr i v a t e R e s po ns e E n t i t y < E r r o r R e s po ns e > bui l dE r r o r R e s po ns e ( E x c e p t i o n e x c e p t i o n, S t r i ng m e s s a g e , H t t pS t a t us h t t pS t a t us , W e bR e que s t r e que s t ) { E r r o r R e s po ns e e r r o r R e s po ns e = ne w E r r o r R e s po ns e ( h t t pS t a t us . v a l ue ( ) , e x c e p t i o n. g e t M e s s a g e (), request.getDescription ( false ) ); r e t ur n R e s po ns e E n t i t y . st a t u s ( h t t pS t a t us ) . bo dy ( e r r o r R e s po ns e ); } Mo di f y Err o rR e s po ns e • publ i c c l a s s E rr o rR e s p o n s e { p ri v a t e f i n a l S t ri n g ti tl e = \"I t e m d o e s n o t e x i s t ! ! ! \" ; p ri v a t e f i n a l i n t st a t u s ; p ri v a t e f i n a l S t ri n g me s s a g e ; p ri v a t e f i n a l S t ri n g in s t an c e ; p ri v a t e S t ri n g st a c k T r a c e ; p ri v a t e Li s t < V a l i d a t i o n E rr o r > e rr o r s ; p ri v a t e f i n a l Lo c a l D a t eT i m e ti me s t a mp = Lo c a l D a t eT i m e . no w ();","libVersion":"0.3.1","langs":""}